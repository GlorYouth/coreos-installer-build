name: Daily coreos-installer Build and Conditional Release

on:
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 时间 00:00 (午夜) 运行
  workflow_dispatch:
    # 允许手动触发此工作流

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 授予写入权限以创建 Release
      actions: write # 授予写入权限以上传/下载 artifacts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libzstd-dev

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build coreos-installer
        # 恢复使用 cargo build --release --locked，确保二进制文件在 target/release/
        run: cargo install coreos-installer --target-dir .

      - name: Calculate current coreos-installer SHA256 and save to file
        id: calculate_sha
        run: |
          CURRENT_SHA256=$(sha256sum target/release/coreos-installer | awk '{print $1}')
          echo "current_sha256=$CURRENT_SHA256" >> "$GITHUB_OUTPUT"
          echo "Current coreos-installer SHA256: $CURRENT_SHA256"
          # 无论是否 Release，都将当前的 SHA256 保存到文件中
          mkdir -p ./.github/ # 确保目录存在
          echo "$CURRENT_SHA256" > ./.github/coreos-installer_sha256.txt

      - name: Download previous SHA256 artifact
        uses: actions/download-artifact@v4
        with:
          name: previous-sha256
          path: ./.github/
        continue-on-error: true # 第一次运行或没有 artifact 时，允许失败

      - name: Check for previous SHA256
        id: check_previous_sha
        run: |
          PREVIOUS_SHA_FILE="./.github/coreos-installer_sha256.txt"
          PREVIOUS_SHA256=""

          # 这里下载的artifact会覆盖当前生成的coreos-installer_sha256.txt
          # 所以需要判断是否是第一次运行或者artifact是否已过期
          # 最好的方式是把下载的artifact保存到另一个名字的文件中
          DOWNLOADED_PREVIOUS_SHA_FILE="./.github/downloaded_previous_sha256.txt"

          if [ -f "$DOWNLOADED_PREVIOUS_SHA_FILE" ]; then
            PREVIOUS_SHA256=$(cat "$DOWNLOADED_PREVIOUS_SHA_FILE")
            echo "Previous coreos-installer SHA256 (from artifact): $PREVIOUS_SHA256"
          else
            echo "No previous coreos-installer SHA256 artifact found."
          fi

          echo "previous_sha256=$PREVIOUS_SHA256" >> "$GITHUB_OUTPUT"

      - name: Compare SHA256 and set release flag
        id: compare_sha
        run: |
          CURRENT_SHA="${{ steps.calculate_sha.outputs.current_sha256 }}"
          PREVIOUS_SHA="${{ steps.check_previous_sha.outputs.previous_sha256 }}"
          NEEDS_RELEASE="false"

          if [ -z "$PREVIOUS_SHA" ]; then # 第一次运行或者 artifact 已过期
              NEEDS_RELEASE="true"
              echo "No previous SHA256 found (first run or artifact expired). A release is needed."
          elif [ "$CURRENT_SHA" != "$PREVIOUS_SHA" ]; then
              NEEDS_RELEASE="true"
              echo "SHA256 values differ. A new release is needed."
          else
              echo "SHA256 values are the same. No new release needed."
          fi

          echo "needs_release=$NEEDS_RELEASE" >> "$GITHUB_OUTPUT"

      - name: Prepare release assets
        if: ${{ success() && steps.compare_sha.outputs.needs_release == 'true' }} # 仅当构建成功且需要 Release 时才准备资产
        run: |
          mkdir -p release_assets
          ASSET_NAME="coreos-installer-$(date +%Y%m%d)-x86_64-unknown-linux-gnu"
          cp target/release/coreos-installer release_assets/$ASSET_NAME
          sha256sum release_assets/* > release_assets/SHA256SUMS
          # 注意：coreos-installer_sha256.txt 已经在 calculate_sha 步骤中创建了
          # 这里不再需要重复创建，但确保它在 release_assets 目录中以便上传（如果需要作为发布资产的话）
          # 如果你只希望它作为artifact上传，而不作为release资产，这里就不需要复制
          # cp ./.github/coreos-installer_sha256.txt release_assets/coreos-installer_sha256.txt # 如果需要作为发布资产

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: ${{ success() && steps.compare_sha.outputs.needs_release == 'true' }} # 仅当构建成功且需要 Release 时才创建 Release
        with:
          tag_name: nightly-$(date +%Y%m%d)
          name: coreos-installer Nightly Build $(date +%Y-%m-%d)
          body: |
            ### Daily Build of coreos-installer

            This is an automated nightly build of `coreos-installer` from the `main` branch.

            **Build Date:** $(date +%Y-%m-%d)
            **Commit:** ${{ github.sha }}

            **Assets:**
            - `coreos-installer-$(date +%Y%m%d)-x86_64-unknown-linux-gnu`
            - `SHA256SUMS`

            *Note: This is a nightly build and may contain unstable features or bugs. Use at your own risk.*
          files: |
            release_assets/*
            # 如果 coreos-installer_sha256.txt 也要作为 release 资产，取消注释上一行的 cp 命令
            # 否则它只作为 artifact 上传，供下次工作流使用
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload current SHA256 as artifact
        uses: actions/upload-artifact@v4
        with:
          name: previous-sha256
          path: ./.github/coreos-installer_sha256.txt # 确保上传这个文件
          retention-days: 7 # 保留 artifact 7 天
        if: always() # 无论构建是否成功，都尝试上传 SHA256，确保下次有数据